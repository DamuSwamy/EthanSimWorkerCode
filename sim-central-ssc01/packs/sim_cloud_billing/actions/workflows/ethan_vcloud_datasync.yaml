version: 1.0
tasks:
  # [212, 140]
  get_iaas_vcloud_data:
    action: sim_cloud_billing.get_iaas_vcloud_data
    next:
      - do:
          - insert_into_iaas_vcloud_temp
        when: <% succeeded() %>
        publish:
          - data: <% result().result.output_vms %>
    input:
      log_level: DEBUG
      password: "{{ ctx().password }}"
      username: "{{ ctx().username }}"
  # [202, 38]
  delete_from_iaas_vcloud_temp:
    action: sql.delete
    next:
      - do:
          - get_iaas_vcloud_data
        when: <% succeeded() %>
    input:
      log_level: DEBUG
      table: Iaas_vCloud_Temp
      connection: "{{ ctx().connection }}"
  # [204, 237]
  insert_into_iaas_vcloud_temp:
    action: sql.insert_bulk
    input:
      log_level: DEBUG
      data: "{{ ctx().data }}"
      table: Iaas_vCloud_Temp
      connection: "{{ ctx().connection }}"
    next:
      - do:
          - get_iaas_vcloud_data2
        when: <% succeeded() %>
  # [192, 394]
  delete_from_iaas_vcloud:
    action: sql.delete
    input:
      log_level: DEBUG
      table: Iaas_vCloud
      connection: "{{ ctx().connection }}"
    next:
      - do:
          - insert_data_into_iaas_vcloud
        when: <% succeeded() %>
  # [194, 505]
  insert_data_into_iaas_vcloud:
    action: sql.query
    input:
      log_level: DEBUG
      query: INSERT INTO Iaas_vCloud SELECT [ethvCloudID] ,[vCloudID] ,[vCloudvAppID] ,[vCloudvApp] ,[vDCS] ,[ethvmid] ,[custidx] ,[CustomerName] ,[vmID] ,[vmUuid] ,[vmName] ,[vmHostName] ,[vmIPAddress] ,[vmCPU] ,[vmRAM] ,[vmStorageUsed] ,[vmStorageTotal] ,[vmPowerState] ,[vmHost] ,[vmBootTime] ,[vmSystemType] ,[vmGuestToolsStatus] ,[vmGuestToolsVersion] ,[vmGuestOSName] ,[vmOrg] ,[vmCreatedDate] ,[vmRemovedDate] ,[vmActive] ,[vmStorageSnapshotSize] ,[vmStorageSnapshot] ,[CPUHotadd] ,[MemoryHotadd] ,[lastUpdated] FROM Iaas_vCloud_Temp
      connection: "{{ ctx().connection }}"
    next:
      - do:
          - exec_usp_loaddatavcenter
        when: <% succeeded() %>
  # [192, 612]
  exec_usp_loaddatavcenter:
    action: mssql.execute.query
    input:
      log_level: DEBUG
      database: "{{ ctx().connection }}"
      query_string: "exec usp_loaddatavcenter"
    next:
      - do:
          - exec_usp_loaddatavcloud
        when: <% succeeded() %>
  # [191, 712]
  exec_usp_loaddatavcloud:
    action: mssql.execute.query
    input:
      log_level: DEBUG
      query_string: "exec usp_loaddatavcloud"
      database: "{{ ctx().connection }}"
  # [521, 239]
  get_iaas_vcloud_data2:
    action: sim_cloud_billing.get_iaas_vcloud_data2
    next:
      - do:
          - insert_into_iaas_vcloud_temp2
        when: <% succeeded() %>
        publish:
          - data2: <% result().result.output %>
    input:
      log_level: DEBUG
      refresh_token: "{{ ctx().refresh_token }}"
  # [518, 349]
  insert_into_iaas_vcloud_temp2:
    action: sql.insert_bulk
    input:
      log_level: DEBUG
      data: "{{ ctx().data2 }}"
      table: Iaas_vCloud_Temp
      connection: "{{ ctx().connection }}"
    next:
      - do:
          - delete_from_iaas_vcloud

    
input:
  - connection
  - username
  - password
  - refresh_token
