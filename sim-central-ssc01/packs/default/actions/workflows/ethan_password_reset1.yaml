version: 1.0
tasks:
  # [360, 241]
  task1:
    action: core.http
    input:
      url: "https://sim-etest.sim.esecure.systems/api/v1/executions"
      allow_redirects: true
      body: "{\"action\": \"core.winrm_ps_cmd\", \"parameters\": {\"cmd\": \"Set-ADAccountPassword -Identity (Get-ADUser -Filter {UserPrincipalName -eq '{{ctx().username}}'}).DistinguishedName -Reset -NewPassword (ConvertTo-SecureString -AsPlainText '{{ctx().password}}' -Force)\", \"host\": \"10.234.16.10\", \"password\": \"Saturday123!\", \"username\": \"sim_test\", \"verify_ssl_cert\": false}"
      headers:
        St2-Api-Key: OWJjNGVhNDg3MmQ0MDM1NTc5ZjEyMzBiZmJhZTcwYmU0MTkxOWEwNTEwODY3MGU4NjA0Y2NhZTc5YmJiM2Y3OQ
      method: POST
      verify_ssl_cert: false
    next
  # [360, 81]
  task4:
    action: core.local
    input:
      cmd: "tr -dc 'A-Za-z0-9!@#$%^&*' </dev/urandom | head -c 16 ; echo ''"
    next:
      - do:
          - task1
        when: <% succeeded() %>
        publish:
          - password: <% result().stdout %>
input:
  - username
