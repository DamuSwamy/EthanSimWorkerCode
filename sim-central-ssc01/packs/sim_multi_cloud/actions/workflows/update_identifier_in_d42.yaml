version: 1.0
tasks:
  # [16, 0]
  generates_device_42_token:
    action: sim_multi_cloud.generates_dev42_token
    next:
      - do:
          - get_d42_devices
        when: < % succeeded %>
        publish:
          - token1: <% result().stdout %>
    input:
      log_level: DEBUG
      username: "{{ ctx().Device42_username }}"
      password: "{{ ctx().Device42_password }}"
  # [167, 107]
  get_d42_devices:
    action: sim_multi_cloud.get_D42_devices
    next:
      - do:
          - passwordstate_get_secret_id
    input:
      log_level: DEBUG
      bearer_token: "{{ ctx().token1 }}"
  # [935, 704]
  update_identifier_in_D42:
    action: sim_multi_cloud.update_custom_field
    input:
      log_level: DEBUG
      token: "{{ ctx().token1 }}"
  # [391, 352]
  generate_azure_token:
    action: sim_multi_cloud.generate_azure_token
    next:
      - do:
          - get_subscription_details
        publish:
          - token2: <% result().stdout %>
    input:
      log_level: DEBUG
      clieent_secret: <%ctx().secret_id%>
  # [538, 464]
  get_subscription_details:
    action: sim_multi_cloud.get_subscription_details_azure
    next:
      - do:
          - get_azure_vm_details
    input:
      log_level: DEBUG
      bearer_token: "{{ ctx().token2 }}"
  # [763, 573]
  get_azure_vm_details:
    action: sim_multi_cloud.get_azure_vm_details
    next:
      - do:
          - update_identifier_in_D42
    input:
      log_level: DEBUG
      bearer_token: "{{ ctx().token2 }}"
  # [257, 234]
  passwordstate_get_secret_id:
    action: core.local
    next:
      - do:
          - generate_azure_token
        publish:
          - secret_id: <% result().stdout[0].Password%>
    input:
      cmd: "curl --location --request GET \"https://pwd.ecorp.systems//api/passwords/35423\" --header 'APIKey: b5fe43a237c896d62bf47d98ae35c32b'"

input:
  - Device42_username
  - Device42_password
  - Azure_client_id
  - Azure_client_secret
