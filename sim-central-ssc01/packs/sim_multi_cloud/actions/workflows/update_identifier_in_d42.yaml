version: 1.0
tasks:
  # [115, 37]
  generates_device_42_token:
    action: sim_multi_cloud.generates_dev42_token
    next:
      - do:
          - get_d42_devices
        when: < % succeeded %>
        publish:
          - token1: <% result().stdout %>
    input:
      log_level: DEBUG
      username: "{{ ctx().Device42_username }}"
      password: "{{ ctx().Device42_password }}"
  # [256, 189]
  get_d42_devices:
    action: sim_multi_cloud.get_D42_devices
    next:
      - do:
          - generates_azure_token
    input:
      log_level: DEBUG
      bearer_token: "{{ ctx().token1 }}"
  # [323, 341]
  generates_azure_token:
    action: sim_multi_cloud.generates_azure_token
    next:
      - do:
          - get_vm_from_azure
        when: <% succeeded %>
        publish:
          - token2: <% result().stdout %>
    input:
      log_level: DEBUG
      clieent_id: "{{ ctx().Azure_client_id }}"
      clieent_secret: "{{ ctx().Azure_client_secret }}"
  # [440, 501]
  get_vm_from_azure:
    action: sim_multi_cloud.get_azure_vm_details
    next:
      - do:
          - update_identifier_in_D42
    input:
      log_level: DEBUG
      bearer_token: "{{ ctx().token2 }}"
  # [577, 644]
  update_identifier_in_D42:
    action: sim_multi_cloud.update_custom_field
    input:
      log_level: DEBUG
      token: "{{ ctx().token1 }}"
input:
  - Device42_username
  - Device42_password
  - Azure_client_id
  - Azure_client_secret
