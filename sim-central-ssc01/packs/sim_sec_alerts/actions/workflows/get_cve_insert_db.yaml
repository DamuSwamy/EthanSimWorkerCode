version: 1.0
tasks:
  # [385, 76]
  get_cves:
    action: sql.query
    input:
      log_level: DEBUG
      debug: false
      query: "SELECT distinct(cve)\nFROM  [CloudManagement].[dbo].[Sec_vulnerability_assets]"
      connection: cloudmanagement
    next:
      - do:
          - get_details_NIST
        when: <% succeeded() %>
        publish:
          - cve_list: <% result().result %>
  # [385, 198]
  get_details_NIST:
    action: sim_sec_alerts.get_cve_details_nist
    next:
      - do:
          - delete_records
        when: <% succeeded() %>
        publish:
          - cve_details: <% result().result %>
    input:
      log_level: DEBUG
      cve_list: "{{ ctx().cve_list }}"
  # [385, 317]
  delete_records:
    action: sql.delete
    input:
      log_level: DEBUG
      table: sec_vulnerability_summary
      connection: cloudmanagement
    next:
      - do:
          - insert_records
        when: <% succeeded() %>
  # [379, 441]
  insert_records:
    action: sql.insert_bulk
    input:
      log_level: DEBUG
      data: "{{ctx().cve_details}}"
      table: sec_vulnerability_summary
      connection: cloudmanagement
