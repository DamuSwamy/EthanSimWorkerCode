---
version: 1.0

description: Automated collection of Asset vulnerability data from NIST

vars:
  - notifications: []
  - process_name: "Security Vulnerability Assets scan"

output:
  - assets: <% ctx().assets_clean %>

tasks:
  # [1220, 78]
  Start:
    action: core.noop
    next:
      - when: <% succeeded() %>
        publish:
          - notification: (<% ctx().process_name%>) process started
        do:
          - notify
          - select_nw_assets
  # [1767, 473]
  notify:
    action: core.echo
    input:
      message: <% ctx().notification %>
  # [988, 260]
  select_nw_assets:
    action: sql.query
    input:
      log_level: DEBUG
      query: "select net_a.AssetID\n,sec_l.cpeID\n,left(replace(sec_l.cpeID, 'cpe:2.3:h:',''), charindex(':',replace(sec_l.cpeID, 'cpe:2.3:h:',''))-1) MatchingVendor\n,left(replace(sec_l.cpeID, 'cpe:2.3:h:cisco:',''), charindex(':',replace(sec_l.cpeID, 'cpe:2.3:h:cisco:',''))-1) MatchingModel\n,\ncase when\nCHARINDEX(' ',replace(net_o.IOSVersion,',',' ')) > 0\nthen\nreplace(replace(left(net_o.IOSVersion, CHARINDEX(' ',replace(net_o.IOSVersion,',',' '))-1), '(','\\('), ')','\\)')\nelse\nreplace(replace(net_o.IOSVersion, '(','\\('), ')','\\)')\nend MatchingOSVersion\n,case\nwhen net_o.OSType = 'NXOS' then 'nx_os'\nwhen net_o.OSType = 'IOSXE' then 'ios_xe'\nwhen net_o.OSType = 'IOS' then 'ios'\nelse net_o.OSType\nend MatchingOSType\n,net_o.IOSVersion\n,net_o.OSType\n,net_d.DeviceName\n,net_d.Manufacturer\n,net_a.Model\nfrom NetworkCustomerDeviceOS net_o\n,NetworkCustomerSiteDevices net_d\n,NetworkCustomerDeviceAssets net_a\n,sec_device_linkage sec_l\nwhere net_d.Monitor_SW_NodeID = net_o.SWNodeID\nand net_a.DeviceID = net_d.DeviceID\nand sec_l.deviceName = net_a.Model"
      connection: cloudmanagement
    next:
      - do:
          - remove_empty_cpe
          - notify
        publish:
          - records: <% result().result %>
          - assets_clean: "{%- set assets = [] %}\n{%- for asset in ctx().records if asset.cpeID is not none -%}\n{{ assets.append(asset) or \"\" }}\n{%- endfor -%}\n{%- set result = assets\n-%}\n{{result|tojson}}"
          - notification: <% len(ctx().records) %>  assets retrieved. <% len(ctx().assets_clean) %>
  # [1052, 414]
  remove_empty_cpe:
    action: core.noop
    next:
      - do:
          - collect_NIST_data
        publish:
          - output_json: '{{ ctx().assets_clean | from_json_string  }}'
  # [1144, 549]
  collect_NIST_data:
    action: sim_sec_alerts.sec_collect_NIST_asset_data
    input:
      log_level: DEBUG
      asset: "{{ctx().records}}"
      timeout: 1200
    next:
      - when: <% succeeded() %>
        publish:
          - notification: <% result().result %>
          - cves: <% result().result %>
        do:
          - Delete_current_data
      - when: <% failed() %>
        do: fail
  # [1261, 812]
  insert_records_sec_vul:
    action: sql.insert_bulk
    input:
      log_level: DEBUG
      data: "{{ctx().cves}}"
      table: sec_vulnerability_assets
      connection: cloudmanagement
  # [1257, 689]
  Delete_current_data:
    action: sql.delete
    next:
      - do:
          - insert_records_sec_vul
    input:
      log_level: DEBUG
      table: sec_vulnerability_assets
      connection: cloudmanagement
